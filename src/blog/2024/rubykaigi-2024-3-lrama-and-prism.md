---
published: 2024-06-12T00:00:00.000+09:00
lastUpdated: null
author: Masafumi Koba
tags: ruby, rubykaigi
---

# RubyKaigi 2024 (3) - Lrama and Prism

[前回（2）](rubykaigi-2024-2.md)の続き。今回は1日目の「[The grand strategy of Ruby Parser](https://rubykaigi.org/2024/presentations/spikeolaf.html)」というトークの感想を書いてみたい。

## Lrama with grand strategy

[The grand strategy of Ruby Parser - Speaker Deck](https://speakerdeck.com/player/198a463233b649578b8b68a0d0f1758e)

このセッションについては、昨年（RubyKaigi 2023）の「**大パーサー時代**」トークを見ておくとさらに理解が深まるので、ぜひスライド・動画を参照されたい。

<details>
<summary>昨年のスライド・動画</summary>

[The future vision of Ruby Parser - Speaker Deck](https://speakerdeck.com/player/b5dd3e98d2b24999a61953cad0734a9a)

[\[JA\] The future vision of Ruby Parser / Yuichiro Kaneko @spikeolaf - YouTube](https://www.youtube.com/watch?v=IhfDsLx784g)

</details>

せっかくなので、[昨年の自分のブログ記事](../2023/rubykaigi-2023.md)も読み返してみた。

> 何かこう、右肩上がりの、ワクワクした感じがコミュニティに広まっているよう感がある。 この進化のスピードは凄まじく、今のRubyでもっとも熱量を感じる分野だ。

ちょうど1年前に書いた文章だが、期待していたことが実現されていて怖いくらいだ。

今回のトーク、何と言っても驚いたのは、kanekoさんの熱が伝播して**チーム**がしっかりと形成されていたことだ。どのようにチームが形成されたか、経緯はわからないが、それを促したものは推測できる。すなわち、

- 明確かつ適切な数の目標
- 目標から逆算した戦略
- 戦略を実現するスコープ・依存関係が明確なタスク群

などが整理されることで、チームワークが円滑に進んだと思う。もちろん活発なコミュニケーションがこれらの基盤になっていたはずだ。

前年のセッションで提示された目標に大きな変更はないものの、より洗練された印象を受けた。トークタイトルにある「Grand strategy（大戦略）」（[Wikipedia](https://en.wikipedia.org/wiki/Grand_strategy)）に強い意志を感じる。
つまり、目標を効果的に達成するための、戦略の重要性である。

OSSであれビジネスであれ、長期にわたるプロジェクトというのものはえてして目標を見失いがちである。しかし、目標とタスクが明確な場合、チームメンバーは進捗への確信が得られるためモチベーションを保ちやすく、また新しいコントリビュータも入ってきやすい。
ほとんどボランティアワークとなるOSSにとって、既存メンバーのモチベーションの維持や、コントリビュータの確保はしばしば死活問題になる[^1]。

そして、このプロジェクトの根幹をなすものこそ**LRパーサ**への情熱であり信念だと言えるだろう。やはり熱がないと、どんなに目標や戦略が優れていても、人は動かないものだ。

プログラマは問題解決が大好きだ。だがしばしば問題解決（How）に熱中しすぎて、目標（What）を見失う。

LRパーサもまた構文解析アルゴリズム、つまりHowのひとつに過ぎないのだが、しかしこのHowこそが目標を最もスマートに達成できる信念が、チームを強固に連帯させているように見える。
長年プログラマをやってはいるが、こういうチームの在り方は目にしたことがない。この非常に稀有な価値観が、「大パーサー時代」発表から**たった1年**でこれほどまでの成果を達成することができた要因だと思える。

ひとつ忘れてならないのは、これがボランティアによって成し遂げられている点だ。OSSの素晴らしい点であり、企業であればむしろ実現されてないかもしれない。

熱量は最重要だが、それを現実的なものにしたのは戦略であり、それが可能にしたチームだ。Lramaチームの非凡さは、未来へのワクワク感を自然と抱かせてくれる。
今回のRubyKaigiにLrama関連のトークがいくつか登場したことが、チームの強力さを証明している。

[ruby/lrama: Pure Ruby LALR parser generator](https://github.com/ruby/lrama)

## Prism as rival

ところで、これをコインの裏側から見てみようと思う。Prismという好敵手（ライバル）の存在だ。

[ruby/prism: Prism Ruby parser](https://github.com/ruby/prism)

RubyKaigi 2024に先立って、Prismを含むRubyパーサについてのいくつかの記事が公開されていたので、ここに紹介する（すべて2024年）。
すべてLrama/Prismの作者たちによって書かれた記事なので信頼性は言うまでもないし、すべて目を通せば昨今のRubyパーサ事情をある程度理解できるだろう。

- 1月23日：[Prism：エラートレラントな、まったく新しいRubyパーサ | gihyo.jp](https://gihyo.jp/article/2024/01/ruby3.3-prism)（[原文](https://kddnewton.com/2024/01/23/prism.html)）
- 1月24日：[Lrama LRパーサジェネレータが切り開く、Rubyの構文解析の未来 | gihyo.jp](https://gihyo.jp/article/2024/01/ruby3.3-lrama)
- 5月15日[^2]：[Ruby: 2024年までのPrismパーサーの長い歴史を振り返る（翻訳）｜TechRacho by BPS株式会社](https://techracho.bpsinc.jp/hachi8833/2024_05_15/141871)（[原文](https://railsatscale.com/2024-04-16-prism-in-2024/)）

PrismもまたLramaと同じような目標を掲げる。つまり、メンテしやすさ、LSPなどモダンなツールからの使いやすさ、移植性、などだ。同様の目標を掲げつつ、両者の手法はまったく異なる。
Lramaが文法定義ファイルからパーサプログラムを自動生成するのに対し、Prismはパーサを手書きする。解法が異なるにも関わらず、どちらもメンテしやすさを達成できると主張している。

正直なところ、この点がまだよくわかっていない。

Lramaは、文法定義から文法を理解するのが簡単で、文法の衝突を検知しやすいと主張する。特に後者は、今後の文法変更のセーフガードとなることが期待されるので、説得力がある。これは手書きのPrismにはない特徴だ。

一方、文法定義の理解しやすさについては、個人の好みや経験によって異なるのでは？という疑念も多少ある。現状の文法定義ファイル（[`parse.y`](https://github.com/ruby/ruby/blob/32683aa18db667ac740bc562eca5989640ae1612/parse.y)）はBNFの拡張とはいうもののCのコードが多分に含まれているため純粋な文法定義ではなく、読み解くにはC言語やCRuby実装の知識がかなり要求される。
また、定義ファイルから自動生成されたソースコードを読む必要が生じた場合、人間が読めるのだろうか？そもそも生成されたパーサコードは読むものではない？少なくともLramaのアルゴリズムに関する知識は多少もっておく必要がある気がする。

ただ、将来的に文法定義ファイルはより読みやすいものに改良されていくだろうから、現時点で結論づけるのは時期尚早かもしれない。

Prismもまたメンテナンス性を主張する。Prismのコアは [`prism.c`](https://github.com/ruby/prism/blob/525b3f88b88d446b2c301f1da08798fb5670d2b8/src/prism.c) という現時点で2万行を超える大きなファイルだ。
このファイルが本当にメンテしやすいかどうかはちょっとわからないのだが、件のブログ記事によるとどうもドキュメントのテストの整備によって担保しているようだ。私はC言語がほとんど読めないので `prism.c` のメンテナンス性について評価はできないが、自動生成をしない分Lramaより抽象レベルは1段低いように思う。ただ、それがメンテナンス性にどこまで影響するかはちょっと不明だ。

まとめると、文法の衝突を検知できるという点でLramaに分があるように思える。あとは、`parse.y` と `prism.c` どちらが読みやすいかという話になりそうだが、私には今のところ評価できない。

次に、Prismの偉業に言及する。

Prismはほんの1、2年でRubyエコシステム内に散らばるパーサの大統一を果たしつつある。JRubyやTruffleRubyなどのRuby実装はパーサをPrismに置き換えた。
また、[parser gem](https://github.com/whitequark/parser)などのパーサgemたちも近い将来、Prismに置き換わるだろう。例えば、parser gemに強く依存するRuboCopは、バックエンドに[Prismを利用するオプションをすでに実装済み](https://metaredux.com/posts/2024/03/09/rubocop-1-62-introduces-experimental-support-for-prism.html)だ。Prismによって提供されるAST変換用のAPIを利用しているようだ。

これもまた、大変な偉業だ。非常に短期間で、エコシステム内の痛みをほぼ解消しようとしている。互換性にも気を配られてるので、これからのRubyコードをパースしたいプログラマは、ただPrism APIを知っているだけど良いし、すでに別のgemやRipperなどの標準ライブラリを使っている場合でも、互換レイヤーのお陰でコードを変更する必要がない（多分）。これらに依存しているコードは年月をかけて徐々にPrismを直接書き換えられていくだろう。もしかしたら、RuboCopの自動修正を使って一気に書き換えることができるようになるかもしれない。

特筆すべきはやはり、大統一ASTの策定だろう。同じくShopify内で開発されている[Ruby LSP](https://github.com/Shopify/ruby-lsp)からのフィードバックを受けて、AST設計を改善していったと思われる。LSPの要求がPrismを鍛え上げていったと言えるだろう。

## Future

さて、未来はどうなるだろうか。LramaとPrism、両者は多くの目標で重なり合いながら、手法の点で対立している。この対立はエコシステムにとっては望ましくないだろう。

しかし、両者は希望のある未来を示唆している。kanekoさんのスライドの[P.119](https://speakerdeck.com/yui_knk/the-grand-strategy-of-ruby-parser?slide=119)にはこう書かれている。

> Compatibility layer for Prism interfaces

さらに、先ほどあげた ["Prism in 2024"](https://railsatscale.com/2024-04-16-prism-in-2024/) ブログ記事の最後にもこうある（翻訳はhachi8833さんによる）。

> Fortunately for those not developing CRuby, to ease concerns about the future Matz has agreed that going forward the official parser API for Ruby will be the Prism API.
>
> CRuby開発者以外の人々にとって幸いなことに、Matzは将来への不安を和らげるため、今後Rubyの公式パーサーAPIがPrismになることに同意しました。

どういう形で互換レイヤーがLramaによって提供されるのか、また、互換レイヤーのパフォーマンスオーバーヘッドや、互換レイヤー生成の複雑性など、気になることいくつかあるが、とにかく大多数のユーザが触れるAPIはPrismで統一されるということで良さそうである。

ただ、2つのパーサが共存するのはやはり望ましくないから、最終的に両者が統合されるべき、というのが私の考えである。今のところLramaが提供する文法定義に分がありそうだから、LramaがPrism APIを実装したパーサを生成するのが良さそうな気がするが、いかんせん詳細に疎いので実際に可能かどうかは私には分からない。

また、PrismはLSPによって高パフォーマンスを要求されるので、それを満足させるパーサをLRアルゴリズムが生成できるかどうかも気になるところである。ガリガリにチューニングしたいとき、自動生成だと手書きパーサに劣る、なんてことはあるのかどうか。

ところで、現代ではパーサには2つの用途があると考えている。

- Rubyコードを解釈して実行するとき
- LSPエディタでRubyコードを開発するとき

前者はエラートレラント性や具象構文木は不要だ。構文エラーの場合はプログラムを終了させればいいし、プログラム実行に不要なコメントや空白などを記憶する必要はない。一方、後者はリッチな開発体験のためには必須だし、解析速度もまた重要だ（反応が遅いエディタの体験を想像してみるといい）。つまり、解析パフォーマンスに関連する変数が変わってくる。

ひとつのパーサ実装ですべての用途をカバーできるのが理想だが、果たしてどうだろうか。このあたりの今後も気になるところである。

## Fukuoka, September 7th

長くなってしまったが、最後に沖縄でjimlockさんに教えていただいたイベントを紹介して終わることにしよう。開催日は**2024年9月7日**、場所は**福岡**だ。

[福岡Rubyist会議04 | Fukuoka RubyistKaigi 04](https://regional.rubykaigi.org/fukuoka04/)

キーノートスピーカーがなんとLramaとPrismの作者の2人である。

[齋藤甚六 on X: "とても楽しい 3 日間でした。オーガナイザーの皆さん、今年もありがとうございました！ そんな感謝の気持ちをこめて私からの kaigieffect です。来たる 9 月 7 日（土）に地域 Ruby会議を開催します。なんと Prism 作者 @kddnewton が来日します！ #rubykaigi #fukuokark04 https://t.co/Gq7Cww44Ta" / X](https://x.com/jimlock/status/1791596347751026879)

しかも、Prism作者のKevin Newton氏は来日できるようだ。RubyKaigiには参加していなかったので、これは貴重な機会になる。

配信は無いそうなので、トークを聞きたいならば9月に福岡に行くしかない。刺激的かつリスペクトに満ちた、Rubyパーサの未来を占うセッションを期待したい。

[^1]: OSSの依存性問題に関する有名な風刺画を参照。[xkcd: Dependency](https://xkcd.com/2347/)

[^2]: この翻訳記事は**5月15日**、つまりRubyKaigi 2024開催中に公開されていることに注意してほしい。この記事の公開タイミングは翻訳者のhachi8833さんから直接伺った。初日のオフィシャルパーティ会場への道中、偶然ご一緒させていただいたのだ。翻訳者ならではの色々と貴重な話を聞けて本当に幸運だった。翻訳もやはり熟練を要する技術のひとつであり、AIなどで簡単に習得できるものではない職人技なのだという思いを強くした。
