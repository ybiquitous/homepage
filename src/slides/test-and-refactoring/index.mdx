export { default as theme } from "../theme";
import { Head } from "mdx-deck";

<Head>
  <title>テストとリファクタリング</title>
  <meta name="description" content="テストとリファクタリングについての新入社員向けスライド" />
  <meta name="date.created" content="2017-04-06" />
</Head>

# テストとリファクタリング

---

## テストを書く理由

---

### コーディング時間を短くするため

---

### 例）JavaScript の関数

---

```js
// a÷bを返す。b=0の場合は、0を返す。
function divide(a, b) {
  return a / b;
}
```

---

### この関数にはバグがある！

---

### まずはテストを書く

---

```js
const assert = console.assert;
assert(divide(1, 1) === 1);
assert(divide(1, 0) === 0);
```

---

### [実際にやってみる](https://repl.it/HR0N/2)

---

### テスト失敗！！！

---

### バグを修正する

---

```js
// a÷bを返す。b=0の場合は、0を返す。
function divide(a, b) {
  /* 追加 */
  if (b === 0) {
    return 0;
  }
  return a / b;
}
```

---

### テストを再び実行

---

### テスト成功！！！

---

### 目でバグを探すより速い

---

### テストの自動実行

---

意図せずにバグが混入された場合にも、テストが失敗するのでバグに気づくことができる

---

### このようなテストを「単体テスト」と呼ぶ

---

> コンピュータプログラミングにおいて単体テスト（たんたいテスト）あるいはユニットテストとは、ソースコードの個々のユニット、すなわち、1 つ以上のコンピュータプログラムモジュールが使用に適しているかどうかを決定するために、関連する制御データ、使用手順、操作手順とともにテストする手法である。

— [Wikipedia](https://ja.wikipedia.org/wiki/単体テスト)

---

### つまり、関数などの小さい単位(unit)を対象としたテストのこと

---

### 小さく・簡単に・すばやく

これがポイント

---

## 次に…

---

## リファクタリングをする理由

---

### リファクタリングは「掃除」のようなもの

---

### 日頃から掃除しておくと、キレイな環境を維持できる

---

### 反対に掃除をサボると、どんどん汚くなる

---

### 例）divide 関数の仕様変更

「関数に数値以外が渡されたときは `null` を返す」

---

```js
// a÷bを返す。b=0の場合は、0を返す。
// aまたはbが数値でない場合は、nullを返す。
function divide(a, b) {
  if (b === 0) {
    return 0;
  }
  /* 追加 */
  if (typeof a === "string") {
    return null;
  }
  /* 追加 */
  if (typeof b === "string") {
    return null;
  }
  return a / b;
}
```

---

```js
// test
const assert = console.assert;
assert(divide(1, 1) === 1);
assert(divide(1, 0) === 0);
/* 追加 */
assert(divide("1", 1) === null);
assert(divide(1, "1") === null);
assert(divide("1", "1") === null);
```

---

### テストも追加したし、修正完了！

---

### でも、少し重複があって読みにくい…

---

### これを「コードの臭い」という

---

> コードの臭い（こーどのにおい、英: Code smell）とは、コンピュータプログラミングにおいてプログラムのソースコードに深刻な問題が存在することを示す何らかの兆候のことを言う。

— [Wikipedia](https://ja.wikipedia.org/wiki/コードの臭い)

---

### よし、リファクタリング！

---

```js
// 追加
function isString(arg) {
  return typeof arg === "string";
}
```

---

```js
// a÷bを返す。b=0の場合は、0を返す。
// aまたはbが数値でない場合は、nullを返す。
function divide(a, b) {
  if (b === 0) {
    return 0;
  }
  // 削除
  // if (typeof a === "string") {
  //   return null;
  // }
  // if (typeof b === "string") {
  //   return null;
  // }
  /* 追加 */
  if (isString(a) || isString(b)) {
    return null;
  }
  return a / b;
}
```

---

### テストは変更しない

---

### テストが成功すれば、リファクタリング完了！

---

### そもそも、リファクタリングって？

---

> リファクタリング (refactoring) とは、コンピュータプログラミングにおいて、プログラムの外部から見た動作を変えずにソースコードの内部構造を整理することである。

— [Wikipedia](https://ja.wikipedia.org/wiki/リファクタリング_%28プログラミング%29)

---

### 「プログラムの外部から見た動作」

→ テストのこと

---

### 「ソースコードの内部構造」

→ 関数内の実装コードのこと

---

### テストがあるからこそ、安全にリファクタリングができる

---

### 逆にテストがないと、バグを混入しないか不安でリファクタリングできない

---

### つまり、テストとリファクタリングは不可分なもの

---

### コードは生き物

---

### 仕様変更のないコードは存在しない

---

### テストを書き、リファクタリングする習慣をつけることが大事

---

## 参考文献

---

[![テスト駆動開発入門](https://images-na.ssl-images-amazon.com/images/I/51G6YEDVRKL.jpg)](http://amzn.asia/hirTzEL)

---

[![リファクタリング](https://images-na.ssl-images-amazon.com/images/I/51885S48YPL.jpg)](http://amzn.asia/5fur4wG)

---

## ご静聴ありがとうございました

---

## 質疑応答
